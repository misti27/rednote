<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RedNote Pro - Visual Clone Engineer</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@400;700&family=Ma+Shan+Zheng&family=Noto+Serif+SC:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Dependencies (React, ReactDOM, Babel, Helpers) -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Switch to html-to-image for better rendering fidelity (WYSIWYG) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html-to-image/1.11.11/html-to-image.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
      /* Custom Scrollbar */
      ::-webkit-scrollbar { width: 6px; height: 6px; }
      ::-webkit-scrollbar-track { background: transparent; }
      ::-webkit-scrollbar-thumb { background: #e5e7eb; border-radius: 3px; }
      ::-webkit-scrollbar-thumb:hover { background: #d1d5db; }
      
      /* Hide number input spinners */
      input[type=number]::-webkit-inner-spin-button, 
      input[type=number]::-webkit-outer-spin-button { 
        -webkit-appearance: none; 
        margin: 0; 
      }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 font-sans">
    <div id="root"></div>

    <script type="text/babel" data-presets="typescript,react">
        const { useState, useEffect, useMemo, useRef, forwardRef } = React;

        // --- ICONS ---
        const IconBase = ({ size = 24, className = "", children, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>
        );
        const Settings = (props) => <IconBase {...props}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.39a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></IconBase>;
        const Type = (props) => <IconBase {...props}><polyline points="4 7 4 4 20 4 20 7"/><line x1="9" y1="20" x2="15" y2="20"/><line x1="12" y1="4" x2="12" y2="20"/></IconBase>;
        const ImageIcon = (props) => <IconBase {...props}><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></IconBase>;
        const Trash2 = (props) => <IconBase {...props}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></IconBase>;
        const Palette = (props) => <IconBase {...props}><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/></IconBase>;
        const Download = (props) => <IconBase {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></IconBase>;
        const Save = (props) => <IconBase {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconBase>;
        const Upload = (props) => <IconBase {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></IconBase>;
        const Maximize = (props) => <IconBase {...props}><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/></IconBase>;

        // --- CONSTANTS ---
        const THEMES = [
            { id: 'shockwave', name: '‚ö°Ô∏è ÂÜ≤ÂáªÊ≥¢', bgGradient: 'bg-gradient-to-br from-yellow-200 to-green-200', textColor: '#1a1a1a', accentColor: '#000000', fontFamily: 'Inter', type: 'modern' },
            { id: 'diffuse', name: 'üåà Âº•Êï£ÂÖâ', bgGradient: 'bg-gradient-to-tr from-purple-100 via-pink-100 to-blue-100', textColor: '#4a044e', accentColor: '#db2777', fontFamily: 'Inter', type: 'modern' },
            { id: 'sticker', name: 'üç≠ Ë¥¥Á∫∏È£é', bgGradient: 'bg-rose-50', textColor: '#881337', accentColor: '#fb7185', fontFamily: 'Inter', type: 'modern' },
            { id: 'handwritten', name: 'üìù ÊâãË¥¶ÊÑü', bgGradient: 'bg-orange-50', textColor: '#431407', accentColor: '#ea580c', fontFamily: 'Ma Shan Zheng', type: 'handwritten' },
            { id: 'cinematic', name: 'üé¨ ÁîµÂΩ±ÊÑü', bgGradient: 'bg-gray-900', textColor: '#f3f4f6', accentColor: '#fbbf24', fontFamily: 'Noto Serif SC', type: 'classic' },
            { id: 'tech', name: 'üîµ ÁßëÊäÄËìù', bgGradient: 'bg-slate-900', textColor: '#60a5fa', accentColor: '#3b82f6', fontFamily: 'JetBrains Mono', type: 'tech' },
            { id: 'minimal', name: '‚ö™Ô∏è ÊûÅÁÆÄÁôΩ', bgGradient: 'bg-white', textColor: '#171717', accentColor: '#d4d4d4', fontFamily: 'Inter', type: 'modern' },
            { id: 'memo', name: 'üü° Â§áÂøòÂΩï', bgGradient: 'bg-yellow-100', textColor: '#422006', accentColor: '#ca8a04', fontFamily: 'Inter', type: 'modern' },
            { id: 'geek', name: 'üü¢ ÊûÅÂÆ¢Èªë', bgGradient: 'bg-black', textColor: '#22c55e', accentColor: '#166534', fontFamily: 'JetBrains Mono', type: 'tech' }
        ];

        const DEFAULT_CONTENT = {
            title: 'ÊùéÁ¨ëÊù•ÔºöÊúÄÈáçË¶ÅÁöÑ‰ªªÂä°Ê∞∏ËøúÂè™Êúâ‰∏Ä‰∏™',
            subtitle: 'VOL.01 | 2025',
            tag: 'Ë∂ÖÁ∫ßÂÖ®ÔºÅÂø´Êî∂ËóèÔºÅ',
            body: `Á¨¨82Â§© | ÊùéÁ¨ëÊù•ÔºöÊúÄÈáçË¶ÅÁöÑ‰ªªÂä°Ê∞∏ËøúÂè™Êúâ‰∏Ä‰∏™\n„ÄäÊääÊó∂Èó¥ÂΩì‰ΩúÊúãÂèã„Äã\n\nÂà§Êñ≠‰∏Ä‰ª∂‰∫ãÊÉÖÊòØÂê¶ÁúüÁöÑÈáçË¶ÅÔºåÊ†áÂáÜÂè™Êúâ‰∏Ä‰∏™ÔºöÊòØÂê¶ÂØπÁõÆÊ†áÁöÑÂÆûÁé∞ÊúâÁõä„ÄÇ\n--- \n## Âå∫ÂàÜÁ¥ßÊÄ•ÂíåÈáçË¶Å\nÊàë‰ª¨ÂøÖÈ°ªÂ≠¶‰ºöÂå∫ÂàÜ‚ÄúÁ¥ßÊÄ•‚ÄùÂíå‚ÄúÈáçË¶Å‚Äù„ÄÇÂ§ßÂ§öÊï∞‰∫∫ÂæÄÂæÄË¢´Á¥ßÊÄ•ÁöÑ‰∫ãÊÉÖÊé®ÁùÄËµ∞ÔºåËÄåÂøΩÁï•‰∫ÜÁúüÊ≠£ÈáçË¶ÅÁöÑ‰∫ãÊÉÖ„ÄÇ\n\n## ‰ªÄ‰πàÊòØÈáçË¶Å\nÈáçË¶ÅÁöÑ‰∫ãÊÉÖÈÄöÂ∏∏‰∏çÁ¥ßÊÄ•ÔºåÊØîÂ¶ÇËØª‰π¶„ÄÅÂÅ•Ë∫´„ÄÅÂ≠¶‰π†‰∏ÄÈ°πÊñ∞ÊäÄËÉΩ„ÄÇÂÆÉ‰ª¨ÁöÑÊïàÊûú‰∏ç‰ºöÁ´ãÁ´øËßÅÂΩ±Ôºå‰ΩÜÈïøÊúüÂùöÊåÅ‰ºö‰∫ßÁîüÂ§çÂà©ÊïàÂ∫î„ÄÇ\n\n## ‰∏ìÊ≥®Âäõ\n‰∏ìÊ≥®ÂäõÊòØËøô‰∏™Êó∂‰ª£ÊúÄÁ®ÄÁº∫ÁöÑËµÑÊ∫ê„ÄÇ‰øùÊä§‰Ω†ÁöÑ‰∏ìÊ≥®ÂäõÔºåÂ∞±ÂÉè‰øùÊä§‰Ω†ÁöÑÈí±ÂåÖ‰∏ÄÊ†∑„ÄÇ‰∏çË¶ÅËÆ©Áêê‰∫ãÂç†ÊçÆ‰Ω†ÁöÑÂ§ßËÑëÂ∏¶ÂÆΩ„ÄÇ\n\n‰ªé‰ªäÂ§©ÂºÄÂßãÔºåÊØèÂ§©Êó©‰∏äÂàóÂá∫‰∏â‰ª∂ÊúÄÈáçË¶ÅÁöÑ‰∫ãÊÉÖÔºåÁÑ∂Âêé‰ºòÂÖàÂÆåÊàêÂÆÉ‰ª¨„ÄÇ‰Ω†‰ºöÂèëÁé∞ÔºåÊïàÁéáÊèêÂçáÁöÑ‰∏ç‰ªÖ‰ªÖÊòØ‰∏ÄÁÇπÁÇπ„ÄÇ\n\nÂùöÊåÅÂÅöÈöæËÄåÊ≠£Á°ÆÁöÑ‰∫ã„ÄÇ`
        };

        const DEFAULT_CONFIG = {
            themeId: 'shockwave',
            titleSize: 32,
            bodySize: 16,
            customBgColor: '',
            customTextColor: '',
            customFontFamily: undefined,
            coverImage: null,
            overlayOpacity: 0.2,
            exportWidth: 1200,
            exportHeight: 1600,
        };

        const COMMON_FONTS = [
            { name: 'ÈªòËÆ§Â≠ó‰Ωì', value: '' },
            { name: 'ÊÄùÊ∫êÂÆã‰Ωì', value: 'Noto Serif SC' },
            { name: 'È©¨ÂñÑÊîøÊØõÁ¨î', value: 'Ma Shan Zheng' },
            { name: 'JetBrains Mono', value: 'JetBrains Mono' },
            { name: 'Inter UI', value: 'Inter' },
            { name: 'ÂæÆËΩØÈõÖÈªë', value: 'Microsoft YaHei' },
            { name: 'Èªë‰Ωì', value: 'SimHei' },
            { name: 'Ê•∑‰Ωì', value: 'KaiTi' },
        ];

        // --- CARD COMPONENT ---
        const Card = forwardRef(({ config, content, theme, pageContent, pageIndex, totalPages }, ref) => {
            const bgStyle = config.customBgColor ? { backgroundColor: config.customBgColor } : undefined;
            const textStyle = config.customTextColor ? { color: config.customTextColor } : { color: theme.textColor };
            const fontFamily = config.customFontFamily || theme.fontFamily;
            const isCover = pageIndex === 0;

            const PREVIEW_WIDTH = 375;
            const aspectRatio = config.exportHeight / config.exportWidth;
            const previewHeight = PREVIEW_WIDTH * aspectRatio;
            

            return (
                <div 
                    ref={ref}
                    id={`card-${pageIndex}`}
                    className={`relative overflow-hidden flex flex-col shadow-2xl shrink-0 select-none ${!config.customBgColor ? theme.bgGradient : ''}`}
                    style={{
                        width: `${PREVIEW_WIDTH}px`,
                        height: `${previewHeight}px`,
                        boxSizing: 'border-box',
                        ...bgStyle,
                        ...textStyle,
                        fontFamily: `'${fontFamily}', sans-serif` // Á°Æ‰øùÂ≠ó‰ΩìÊ†∑Âºè‰∏ÄËá¥
                    }}
                >
                    {isCover && config.coverImage && (
                        <div className="absolute inset-0 z-0">
                            <img src={config.coverImage} alt="cover" className="w-full h-full object-cover" />
                            <div className="absolute inset-0 bg-white" style={{ opacity: config.overlayOpacity }} />
                        </div>
                    )}

                    <div className={`relative z-10 h-full flex flex-col ${isCover ? 'justify-center' : ''}`} style={{ padding: '32px' }}>
                        {isCover && (
                            <div className="flex flex-col h-full relative">
                                <div className="absolute top-0 left-0 w-full flex justify-between items-start opacity-60">
                                    <div className="w-8 h-8 border border-current rounded-full flex items-center justify-center">
                                        <span className="text-xs font-bold">R</span>
                                    </div>
                                    <span className="text-xs font-mono tracking-widest">{content.subtitle}</span>
                                </div>
                                <div className="mt-auto mb-12">
                                    <div className="mb-6">
                                        <span className="inline-block px-3 py-1 text-xs font-bold tracking-wider border-2 border-current uppercase">
                                            {content.tag}
                                        </span>
                                    </div>
                                    <h1 className="font-bold leading-[1.15] mb-6 break-words tracking-tight" style={{ fontSize: `${config.titleSize * 1.5}px` }}>
                                        {content.title}
                                    </h1>
                                    <div className="w-16 h-2 bg-current opacity-80 mb-4" />
                                    <p className="text-sm opacity-80 font-medium max-w-[80%] leading-relaxed">
                                        Visual Notes Collection<br/>Designed for Creators.
                                    </p>
                                </div>
                            </div>
                        )}

                        {!isCover && (
                            <>
                                <div style={{ marginBottom: '24px', paddingBottom: '16px', borderBottom: '1px solid currentColor', opacity: 0.2, display: 'flex', alignItems: 'center', gap: '12px' }}>
                                    <span style={{ fontSize: '12px', fontWeight: 'bold', whiteSpace: 'nowrap' }}>{content.subtitle}</span>
                                    <span style={{ width: '1px', height: '12px', backgroundColor: 'currentColor', opacity: 0.5 }}/>
                                    <span style={{ fontSize: '12px', fontWeight: '500', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>{content.title}</span>
                                </div>
                                
                                <div style={{ flex: 1, overflow: 'hidden' }}>
                                    {pageContent.map((item, idx) => {
                                        const text = typeof item === 'string' ? item : item.text;
                                        const isHeading = typeof item === 'string' 
                                            ? text.startsWith('## ')
                                            : item.type === 'heading';
                                        const isEmptyLine = (typeof item === 'object' && item.type === 'empty');

                                        if (isEmptyLine && idx === 0) return null;

                                        if (isHeading) {
                                            const cleanText = text.replace(/^##\s*/, '');
                                            return (
                                                <h3
                                                    key={idx}
                                                    style={{
                                                        fontSize: `${config.bodySize * 1.25}px`,
                                                        lineHeight: `${config.bodySize * 1.25 * 1.3}px`,
                                                        fontWeight: 'bold',
                                                        margin: '0',
                                                        padding: '0',
                                                        marginTop: idx === 0 ? '0px' : `${config.bodySize * 0.8}px`,
                                                        marginBottom: `${config.bodySize * 0.4}px`,
                                                        whiteSpace: 'pre-wrap',
                                                        wordBreak: 'break-all'
                                                    }}
                                                >
                                                    {cleanText}
                                                </h3>
                                            );
                                        }

                                        if (isEmptyLine) {
                                            return (
                                                <div
                                                    key={`empty-${idx}`}
                                                    style={{ 
                                                        height: `${config.bodySize * 1.8}px`,
                                                        margin: '0',
                                                        padding: '0'
                                                    }}
                                                />
                                            );
                                        }

                                        return (
                                            <p
                                                key={idx}
                                                style={{
                                                    fontSize: `${config.bodySize}px`,
                                                    lineHeight: `${config.bodySize * 1.8}px`,
                                                    margin: '0',
                                                    padding: '0',
                                                    marginTop: (() => {
                                                        if (idx === 0) return '0';
                                                        const prevItem = pageContent[idx - 1];
                                                        if (prevItem?.type === 'heading') return `${config.bodySize * 0.6}px`;
                                                        return '0';
                                                    })(),
                                                    whiteSpace: 'pre-wrap',
                                                    wordBreak: 'break-all'
                                                }}
                                            >
                                                {text}
                                            </p>
                                        );
                                    })}
                                </div>
                                
                                <div style={{ marginTop: 'auto', paddingTop: '24px', display: 'flex', justifyContent: 'space-between', alignItems: 'flex-end', opacity: 0.6 }}>
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                                        <div style={{ width: '6px', height: '6px', borderRadius: '50%', backgroundColor: 'currentColor' }}/>
                                        <span style={{ fontSize: '10px', fontFamily: 'monospace', textTransform: 'uppercase', maxWidth: '150px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>
                                            {content.tag}
                                        </span>
                                    </div>
                                    <span style={{ fontSize: '18px', fontWeight: 'bold', fontFamily: 'monospace', opacity: 0.8 }}>
                                        {pageIndex}<span style={{ fontSize: '12px', opacity: 0.5, margin: '0 4px' }}>/</span>{totalPages}
                                    </span>
                                </div>
                            </>
                        )}
                    </div>
                </div>
            );
        });

        // --- EDITOR SIDEBAR COMPONENT ---
        const EditorSidebar = ({ config, setConfig, content, setContent, onDownload, isDownloading, availableThemes, onThemeSelect, onSaveTheme }) => {
            const fileInputRef = useRef(null);
            const fontInputRef = useRef(null);
            const [showSaveDialog, setShowSaveDialog] = useState(false);
            const [newThemeName, setNewThemeName] = useState('');

            const handleImageUpload = (e) => {
                const file = e.target.files?.[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => setConfig(prev => ({ ...prev, coverImage: reader.result }));
                    reader.readAsDataURL(file);
                }
            };

            const handleFontUpload = async (e) => {
                const file = e.target.files?.[0];
                if (file) {
                    try {
                        const reader = new FileReader();
                        reader.onload = async (event) => {
                            const fontDataUrl = event.target.result;
                            const fontName = `CustomFont-${Date.now()}`;
                            
                            // ‚úÖ ÁßªÈô§ÊóßÁöÑÂ≠ó‰ΩìÊ†∑ÂºèÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ
                            const oldStyle = document.getElementById('custom-font-style');
                            if (oldStyle) oldStyle.remove();
                            
                            // ‚úÖ ÂàõÂª∫Êñ∞ÁöÑÂÖ®Â±ÄÊ†∑Âºè
                            const style = document.createElement('style');
                            style.id = 'custom-font-style';
                            style.textContent = `
                                @font-face {
                                    font-family: "${fontName}";
                                    src: url("${fontDataUrl}");
                                    font-weight: normal;
                                    font-style: normal;
                                    font-display: swap;
                                }
                                @font-face {
                                    font-family: "${fontName}";
                                    src: url("${fontDataUrl}");
                                    font-weight: bold;
                                    font-style: normal;
                                    font-display: swap;
                                }
                                @font-face {
                                    font-family: "${fontName}";
                                    src: url("${fontDataUrl}");
                                    font-weight: 600;
                                    font-style: normal;
                                    font-display: swap;
                                }
                            `;
                            document.head.appendChild(style);

                            // ‚úÖ Âä†ËΩΩÂà∞ FontFaceSet
                            try {
                                const fontFace1 = new FontFace(fontName, `url("${fontDataUrl}")`, { weight: 'normal' });
                                const fontFace2 = new FontFace(fontName, `url("${fontDataUrl}")`, { weight: 'bold' });
                                const fontFace3 = new FontFace(fontName, `url("${fontDataUrl}")`, { weight: '600' });
                                
                                await Promise.all([
                                    fontFace1.load(),
                                    fontFace2.load(),
                                    fontFace3.load()
                                ]);
                                
                                document.fonts.add(fontFace1);
                                document.fonts.add(fontFace2);
                                document.fonts.add(fontFace3);
                            } catch (e) {
                                console.warn('FontFace API failed, using style tag only');
                            }
                            
                            await document.fonts.ready;
                            
                            setConfig(prev => ({ ...prev, customFontFamily: fontName }));
                            alert(`Â≠ó‰Ωì "${file.name}" Âä†ËΩΩÊàêÂäüÔºÅ`);
                        };
                        reader.readAsDataURL(file);
                    } catch (err) {
                        console.error("Font load error", err);
                        alert("Â≠ó‰ΩìÂä†ËΩΩÂ§±Ë¥•");
                    }
                }
            };

            const submitSaveTheme = () => {
                if (newThemeName.trim()) {
                    onSaveTheme(newThemeName);
                    setNewThemeName('');
                    setShowSaveDialog(false);
                }
            };

            const setExportPreset = (w, h) => {
                setConfig({ ...config, exportWidth: w, exportHeight: h });
            };

            return (
                <div className="w-full md:w-[420px] bg-white border-r border-gray-200 h-screen overflow-y-auto flex flex-col shadow-xl z-20">
                    <div className="p-5 border-b border-gray-100 flex justify-between items-center sticky top-0 bg-white/95 backdrop-blur z-10">
                        <div className="flex items-center gap-2">
                            <div className="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold text-lg">R</div>
                            <div>
                                <h1 className="font-bold text-gray-800 text-lg leading-none">RedNote Pro</h1>
                                <span className="text-xs text-gray-400">Visual Clone Engineer</span>
                            </div>
                        </div>
                        <button onClick={onDownload} disabled={isDownloading} className={`flex items-center gap-2 px-4 py-2 rounded-lg font-medium text-sm transition-all ${isDownloading ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'bg-gray-900 text-white hover:bg-black hover:shadow-lg active:scale-95'}`}>
                            {isDownloading ? <span className="animate-pulse">Packaging...</span> : <><Download size={16} />ÊâìÂåÖ‰∏ãËΩΩ</>}
                        </button>
                    </div>

                    <div className="p-6 space-y-8 pb-20">
                        <section>
                            <div className="flex justify-between items-center mb-4">
                                <div className="flex items-center gap-2 text-sm font-bold text-gray-500 uppercase tracking-wider"><Palette size={14} />È£éÊ†ºÈÄâÊã©</div>
                                <button onClick={() => setShowSaveDialog(true)} className="text-xs text-blue-600 hover:text-blue-700 flex items-center gap-1 font-medium"><Save size={12} /> ‰øùÂ≠òÂΩìÂâçÈ£éÊ†º</button>
                            </div>
                            
                            {showSaveDialog && (
                                <div className="mb-4 p-3 bg-blue-50 rounded-lg border border-blue-100 animate-fade-in">
                                    <label className="block text-xs font-bold text-blue-800 mb-2">‰∏∫ÂΩìÂâçÈ£éÊ†ºÂëΩÂêç</label>
                                    <div className="flex gap-2">
                                        <input type="text" value={newThemeName} onChange={e => setNewThemeName(e.target.value)} placeholder="‰æãÂ¶ÇÔºöÊàëÁöÑÁ∫¢Ëâ≤‰∏ªÈ¢ò" className="flex-1 px-2 py-1 text-sm border border-blue-200 rounded focus:outline-none focus:border-blue-500" autoFocus />
                                        <button onClick={submitSaveTheme} className="px-3 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700">‰øùÂ≠ò</button>
                                        <button onClick={() => setShowSaveDialog(false)} className="px-2 py-1 text-blue-400 hover:text-blue-600">ÂèñÊ∂à</button>
                                    </div>
                                </div>
                            )}

                            <div className="grid grid-cols-3 gap-3">
                                {availableThemes.map((theme) => {
                                    const isSelected = config.themeId === theme.id;
                                    return (
                                        <button
                                            key={theme.id}
                                            onClick={() => onThemeSelect(theme)}
                                            className={`relative h-12 rounded-lg text-xs font-medium transition-all duration-200 border-2 flex items-center justify-center overflow-hidden ${isSelected ? 'border-blue-600 ring-2 ring-blue-100 scale-[1.02]' : 'border-transparent hover:border-gray-200'} ${theme.id === 'minimal' ? 'bg-gray-50 text-gray-600' : ''}`}
                                            style={{ backgroundColor: theme.savedConfig?.customBgColor || (theme.id === 'minimal' ? '#f9fafb' : undefined), color: theme.savedConfig?.customTextColor || (theme.id === 'minimal' ? undefined : (theme.id === 'geek' || theme.id === 'cinematic' || theme.id === 'tech' ? 'white' : 'black')) }}
                                        >
                                            {!theme.savedConfig?.customBgColor && <div className={`absolute inset-0 opacity-80 ${theme.bgGradient} -z-10`} />}
                                            {theme.name}
                                        </button>
                                    );
                                })}
                            </div>
                        </section>

                        <section className="bg-blue-50 rounded-xl p-4 border border-blue-100">
                            <div className="flex items-center gap-2 mb-4 text-sm font-bold text-blue-600 uppercase tracking-wider">
                                <Maximize size={14} /> ÂØºÂá∫Â∞∫ÂØ∏ (px)
                            </div>
                            <div className="space-y-3">
                                <div className="flex gap-3">
                                    <div className="flex-1">
                                        <label className="text-xs font-medium text-gray-500 mb-1 block">ÂÆΩÂ∫¶ Width</label>
                                        <input 
                                            type="number" 
                                            min="100" max="8000"
                                            value={config.exportWidth} 
                                            onChange={(e) => setConfig({ ...config, exportWidth: Math.max(1, Number(e.target.value)) })} 
                                            className="w-full px-3 py-2 border border-blue-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white"
                                        />
                                    </div>
                                    <div className="flex-1">
                                        <label className="text-xs font-medium text-gray-500 mb-1 block">È´òÂ∫¶ Height</label>
                                        <input 
                                            type="number" 
                                            min="100" max="8000"
                                            value={config.exportHeight} 
                                            onChange={(e) => setConfig({ ...config, exportHeight: Math.max(1, Number(e.target.value)) })} 
                                            className="w-full px-3 py-2 border border-blue-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white"
                                        />
                                    </div>
                                </div>
                                
                                <div className="flex gap-2">
                                    <button onClick={() => setExportPreset(1200, 1600)} className="flex-1 py-1.5 bg-white border border-blue-200 text-blue-600 text-xs rounded hover:bg-blue-50 transition-colors">
                                        3:4 Â∞èÁ∫¢‰π¶ (1200x1600)
                                    </button>
                                    <button onClick={() => setExportPreset(1080, 1920)} className="flex-1 py-1.5 bg-white border border-blue-200 text-blue-600 text-xs rounded hover:bg-blue-50 transition-colors">
                                        9:16 ÂÖ®Â±è (1080x1920)
                                    </button>
                                </div>
                                
                                <div className="text-[10px] text-blue-400 flex justify-between">
                                    <span>ÂΩìÂâçÊØî‰æã: {(config.exportWidth / config.exportHeight).toFixed(2)}</span>
                                    <span>Êé®Ëçê: 1200x1600</span>
                                </div>
                            </div>
                        </section>

                        <section className="bg-gray-50 rounded-xl p-4 border border-gray-100">
                            <div className="flex items-center gap-2 mb-4 text-sm font-bold text-gray-500 uppercase tracking-wider"><Type size={14} />Â§ñËßÇÂæÆË∞É</div>
                            <div className="space-y-5">
                                <div>
                                    <label className="text-xs font-medium text-gray-600 mb-1.5 block">Â≠ó‰ΩìËÆæÁΩÆ</label>
                                    <div className="flex gap-2">
                                        <select value={config.customFontFamily || ''} onChange={(e) => setConfig({ ...config, customFontFamily: e.target.value || undefined })} className="flex-1 text-xs border border-gray-200 rounded-lg px-2 py-2 bg-white focus:outline-none focus:ring-1 focus:ring-blue-500">
                                            {COMMON_FONTS.map(f => <option key={f.value} value={f.value}>{f.name}</option>)}
                                            {config.customFontFamily && !COMMON_FONTS.find(f => f.value === config.customFontFamily) && <option value={config.customFontFamily}>Ëá™ÂÆö‰πâ‰∏ä‰º†Â≠ó‰Ωì</option>}
                                        </select>
                                        <button onClick={() => fontInputRef.current?.click()} className="px-3 py-1 bg-white border border-gray-200 rounded-lg text-gray-600 hover:bg-gray-50 hover:text-blue-600 transition-colors" title="‰∏ä‰º†Â≠ó‰Ωì"><Upload size={14} /></button>
                                        <input ref={fontInputRef} type="file" accept=".ttf,.otf,.woff,.woff2" className="hidden" onChange={handleFontUpload} />
                                    </div>
                                    <p className="text-[10px] text-gray-400 mt-1">* ÊîØÊåÅ‰∏ä‰º† .ttf, .otf, .woff Ê†ºÂºèÂ≠ó‰Ωì</p>
                                </div>
                                <div className="h-px bg-gray-200 my-2"></div>
                                <div>
                                    <div className="flex justify-between mb-1"><label className="text-xs font-medium text-gray-600">Ê†áÈ¢òÂ≠óÂè∑</label><span className="text-xs text-gray-400">{config.titleSize}px</span></div>
                                    <input type="range" min="20" max="64" value={config.titleSize} onChange={(e) => setConfig({ ...config, titleSize: Number(e.target.value) })} className="w-full h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600" />
                                </div>
                                <div>
                                    <div className="flex justify-between mb-1"><label className="text-xs font-medium text-gray-600">Ê≠£ÊñáÂ≠óÂè∑</label><span className="text-xs text-gray-400">{config.bodySize}px</span></div>
                                    <input type="range" min="12" max="24" value={config.bodySize} onChange={(e) => setConfig({ ...config, bodySize: Number(e.target.value) })} className="w-full h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600" />
                                </div>
                                <div className="grid grid-cols-2 gap-4 pt-2">
                                    <div>
                                        <label className="text-xs font-medium text-gray-600 mb-1 block">ËÉåÊôØËâ≤</label>
                                        <div className="flex items-center gap-2 bg-white border border-gray-200 rounded-lg p-1.5">
                                            <input type="color" className="w-6 h-6 rounded cursor-pointer border-none p-0 bg-transparent" value={config.customBgColor || '#ffffff'} onChange={(e) => setConfig({...config, customBgColor: e.target.value})} />
                                            <span className="text-xs text-gray-400">Ëá™ÂÆö‰πâ</span>
                                        </div>
                                    </div>
                                    <div>
                                        <label className="text-xs font-medium text-gray-600 mb-1 block">ÊñáÂ≠óËâ≤</label>
                                        <div className="flex items-center gap-2 bg-white border border-gray-200 rounded-lg p-1.5">
                                            <input type="color" className="w-6 h-6 rounded cursor-pointer border-none p-0 bg-transparent" value={config.customTextColor || '#000000'} onChange={(e) => setConfig({...config, customTextColor: e.target.value})} />
                                            <span className="text-xs text-gray-400">Ëá™ÂÆö‰πâ</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </section>

                        <section>
                            <div className="flex items-center gap-2 mb-4 text-sm font-bold text-gray-500 uppercase tracking-wider"><ImageIcon size={14} />Â∞ÅÈù¢ÈÖçÂõæ</div>
                            <div className="space-y-4">
                                <div className="flex gap-2">
                                    <button onClick={() => fileInputRef.current?.click()} className="flex-1 h-10 border border-dashed border-gray-300 rounded-lg flex items-center justify-center text-sm text-gray-600 hover:bg-gray-50 transition-colors"><ImageIcon size={16} className="mr-2 text-gray-400" />‰∏ä‰º†ÂõæÁâá</button>
                                    <input ref={fileInputRef} type="file" accept="image/*" className="hidden" onChange={handleImageUpload} />
                                    {config.coverImage && <button onClick={() => setConfig({...config, coverImage: null})} className="w-10 h-10 border border-red-100 bg-red-50 text-red-500 rounded-lg flex items-center justify-center hover:bg-red-100"><Trash2 size={16} /></button>}
                                </div>
                                {config.coverImage && (
                                    <div>
                                        <div className="flex justify-between mb-1"><label className="text-xs font-medium text-gray-600">ÈÅÆÁΩ©ÊµìÂ∫¶</label></div>
                                        <input type="range" min="0" max="1" step="0.1" value={config.overlayOpacity} onChange={(e) => setConfig({ ...config, overlayOpacity: Number(e.target.value) })} className="w-full h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600" />
                                    </div>
                                )}
                            </div>
                        </section>

                        <section className="space-y-4">
                            <div className="flex items-center gap-2 mb-2 text-sm font-bold text-gray-500 uppercase tracking-wider"><Settings size={14} />ÂÜÖÂÆπÁºñËæë</div>
                            <div className="space-y-3">
                                <div>
                                    <label className="text-xs text-gray-400 mb-1 block">‰∏ªÊ†áÈ¢ò</label>
                                    <input type="text" value={content.title} onChange={(e) => setContent({ ...content, title: e.target.value })} className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 font-bold" placeholder="ËæìÂÖ•Â§ßÊ†áÈ¢ò" />
                                </div>
                                <div className="grid grid-cols-2 gap-3">
                                    <div>
                                        <label className="text-xs text-gray-400 mb-1 block">ÊúüÊï∞/Êó•Êúü</label>
                                        <input type="text" value={content.subtitle} onChange={(e) => setContent({ ...content, subtitle: e.target.value })} className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="VOL.01" />
                                    </div>
                                    <div>
                                        <label className="text-xs text-gray-400 mb-1 block">Ê†áÁ≠æ/‰ΩúËÄÖ</label>
                                        <input type="text" value={content.tag} onChange={(e) => setContent({ ...content, tag: e.target.value })} className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="‰ΩúËÄÖÂêç" />
                                    </div>
                                </div>
                                <div>
                                    <label className="text-xs text-gray-400 mb-1 block">Ê≠£ÊñáÂÜÖÂÆπ (Ëá™Âä®ÂàÜÈ°µ)</label>
                                    <textarea value={content.body} onChange={(e) => setContent({ ...content, body: e.target.value })} className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm h-48 focus:outline-none focus:ring-2 focus:ring-blue-500 leading-relaxed resize-none" placeholder="Âú®Ê≠§ËæìÂÖ•Ê≠£Êñá..." />
                                </div>
                            </div>
                        </section>
                    </div>
                </div>
            );
        };

        // --- MAIN APP COMPONENT ---
        const App = () => {
            const [availableThemes, setAvailableThemes] = useState(THEMES);
            const [config, setConfig] = useState(DEFAULT_CONFIG);
            const [content, setContent] = useState(DEFAULT_CONTENT);
            const [isDownloading, setIsDownloading] = useState(false);
            const [pages, setPages] = useState([]); // State for pages
            const cardsRef = useRef([]);

            const currentTheme = availableThemes.find(t => t.id === config.themeId) || availableThemes[0];

            const handleThemeSelect = (theme) => {
                if (theme.savedConfig) {
                    setConfig(prev => ({ ...prev, ...theme.savedConfig, themeId: theme.id }));
                } else {
                    setConfig(prev => ({ ...prev, themeId: theme.id, customBgColor: '', customTextColor: '', customFontFamily: undefined }));
                }
            };

            const handleSaveTheme = (name) => {
                const newThemeId = `custom-${Date.now()}`;
                const savedConfigSnapshot = {
                    customBgColor: config.customBgColor,
                    customTextColor: config.customTextColor,
                    customFontFamily: config.customFontFamily,
                    titleSize: config.titleSize,
                    bodySize: config.bodySize,
                    exportWidth: config.exportWidth,
                    exportHeight: config.exportHeight,
                };
                const newTheme = {
                    id: newThemeId,
                    name: name,
                    bgGradient: config.customBgColor ? '' : currentTheme.bgGradient,
                    textColor: config.customTextColor || currentTheme.textColor,
                    accentColor: currentTheme.accentColor,
                    fontFamily: config.customFontFamily || currentTheme.fontFamily,
                    type: currentTheme.type,
                    savedConfig: savedConfigSnapshot
                };
                setAvailableThemes(prev => [...prev, newTheme]);
                setConfig(prev => ({ ...prev, themeId: newThemeId }));
            };

            // Calculate Pages using DOM Measurement
            useEffect(() => {
                const calculatePages = async () => {
                const measureContainer = document.createElement('div');
                measureContainer.style.position = 'absolute';
                measureContainer.style.visibility = 'hidden';
                measureContainer.style.top = '-9999px';
                document.body.appendChild(measureContainer);

                const PREVIEW_WIDTH = 375;
                const aspectRatio = config.exportHeight / config.exportWidth;
                const cardHeight = PREVIEW_WIDTH * aspectRatio;
                const fontFamily = config.customFontFamily || currentTheme.fontFamily;

                // ÂÆåÂÖ®Â§çÂà∂CardÁöÑÊ†∑Âºè
                measureContainer.style.width = `${PREVIEW_WIDTH}px`;
                measureContainer.style.height = `${cardHeight}px`;
                measureContainer.style.padding = '32px'; // p-8
                measureContainer.style.boxSizing = 'border-box';
                measureContainer.style.display = 'flex';
                measureContainer.style.flexDirection = 'column';
                measureContainer.style.fontFamily = `"${fontFamily}", sans-serif`;

                // Mock Header
                const header = document.createElement('div');
                header.style.marginBottom = '24px'; // mb-6
                header.style.paddingBottom = '16px'; // pb-4
                header.style.display = 'flex';
                header.style.alignItems = 'center';
                header.style.gap = '12px';
                header.style.height = '40px'; // Âõ∫ÂÆöÈ´òÂ∫¶
                measureContainer.appendChild(header);

                // Content Container
                const contentWrapper = document.createElement('div');
                contentWrapper.style.flex = '1';
                contentWrapper.style.overflow = 'hidden';
                contentWrapper.style.display = 'block';
                measureContainer.appendChild(contentWrapper);

                // Mock Footer
                const footer = document.createElement('div');
                footer.style.marginTop = 'auto';
                footer.style.paddingTop = '24px'; // pt-6
                footer.style.height = '32px'; // Âõ∫ÂÆöÈ´òÂ∫¶
                measureContainer.appendChild(footer);

                // Pagination Logic
                let currentPages = [];
                let currentLines = [];
                
                const paragraphs = content.body.split('\n');

                for (let i = 0; i < paragraphs.length; i++) {
                    let para = paragraphs[i];
                    
                    // Page Break
                    if (para.trim() === '---' || para.trim() === '***') {
                        if (currentLines.length > 0) {
                            currentPages.push(currentLines);
                            currentLines = [];
                            contentWrapper.innerHTML = '';
                        }
                        continue;
                    }

                    // Á©∫Ë°åÂ§ÑÁêÜ
                    if (para.trim() === '') {
                        // Â¶ÇÊûúÊòØÈ°µÈù¢Á¨¨‰∏ÄË°åÔºåÁõ¥Êé•Ë∑≥Ëøá
                        if (currentLines.length === 0) {
                            continue;
                        }
                        
                        const spacer = document.createElement('div');
                        spacer.style.height = `${config.bodySize * 1.8}px`;
                        spacer.style.margin = '0';
                        spacer.style.padding = '0';
                        contentWrapper.appendChild(spacer);

                        if (contentWrapper.scrollHeight <= contentWrapper.clientHeight) {
                            currentLines.push({ type: 'empty', text: '' });
                        } else {
                            contentWrapper.removeChild(spacer);
                            currentPages.push(currentLines);
                            currentLines = [];
                            contentWrapper.innerHTML = '';
                        }
                        continue;
                    }

                    const isHeading = para.startsWith('## ');
                    const text = isHeading ? para.replace(/^##\s*/, '') : para;
                    const fontSize = isHeading ? config.bodySize * 1.25 : config.bodySize;
                    const lineHeight = isHeading ? config.bodySize * 1.25 * 1.3 : config.bodySize * 1.8;
                    const prevIsHeading = currentLines.length > 0 && currentLines[currentLines.length - 1]?.type === 'heading';
                    const marginTop = currentLines.length === 0 ? 0 : 
                                (isHeading ? config.bodySize * 0.8 : 
                                (prevIsHeading ? config.bodySize * 0.6 : 0));
                    const marginBottom = isHeading ? config.bodySize * 0.4 : 0;

                    // Create Temp Element
                    const el = document.createElement(isHeading ? 'h3' : 'p');
                    el.style.fontSize = `${fontSize}px`;
                    el.style.fontWeight = isHeading ? 'bold' : 'normal';
                    el.style.lineHeight = `${lineHeight}px`;
                    el.style.whiteSpace = 'pre-wrap';
                    el.style.wordBreak = 'break-all';
                    el.style.margin = '0';
                    el.style.padding = '0';
                    el.style.marginTop = `${marginTop}px`;
                    el.style.marginBottom = `${marginBottom}px`;
                    el.textContent = text;

                    contentWrapper.appendChild(el);

                    // Check Overflow
                    if (contentWrapper.scrollHeight <= contentWrapper.clientHeight) {
                        currentLines.push({ type: isHeading ? 'heading' : 'para', text: para });
                    } else {
                        // Overflow happened
                        contentWrapper.removeChild(el);
                        
                        // Heading Logic
                        if (isHeading) {
                            if (currentLines.length > 0) {
                                currentPages.push(currentLines);
                                currentLines = [];
                                contentWrapper.innerHTML = '';
                                
                                el.style.marginTop = '0';
                                contentWrapper.appendChild(el);
                                currentLines.push({ type: 'heading', text: para });
                            } else {
                                currentLines.push({ type: 'heading', text: para });
                            }
                        } else {
                            // Paragraph Logic: Binary search split
                            let low = 0;
                            let high = text.length;
                            let bestFitIndex = 0;
                            
                            while (low <= high) {
                                const mid = Math.floor((low + high) / 2);
                                el.textContent = text.substring(0, mid);
                                contentWrapper.appendChild(el);
                                
                                if (contentWrapper.scrollHeight <= contentWrapper.clientHeight) {
                                    bestFitIndex = mid;
                                    low = mid + 1;
                                } else {
                                    high = mid - 1;
                                }
                                contentWrapper.removeChild(el);
                            }
                            
                            if (bestFitIndex === 0 && currentLines.length > 0) {
                                currentPages.push(currentLines);
                                currentLines = [];
                                contentWrapper.innerHTML = '';
                                i--;
                                continue;
                            }
                            
                            const part1 = text.substring(0, bestFitIndex);
                            if (part1.length > 0) {
                                currentLines.push({ type: 'para', text: part1 });
                            }
                            
                            currentPages.push(currentLines);
                            currentLines = [];
                            contentWrapper.innerHTML = '';
                            
                            const remaining = text.substring(bestFitIndex);
                            if (remaining.length > 0) {
                                paragraphs[i] = remaining;
                                i--;
                            }
                        }
                    }
                }
                
                if (currentLines.length > 0) currentPages.push(currentLines);
                setPages([null, ...(currentPages.length > 0 ? currentPages : [])]);
                
                document.body.removeChild(measureContainer);
            };
                
                document.fonts.ready.then(calculatePages);
            }, [content.body, config.exportWidth, config.exportHeight, config.bodySize, config.titleSize, config.themeId, config.customFontFamily]);

            const handleDownload = async () => {
                setIsDownloading(true);
                console.log('=== ÂºÄÂßãÂØºÂá∫ ===');
                
                try {
                    console.log('1. Á≠âÂæÖÂ≠ó‰ΩìÂä†ËΩΩ...');
                    await document.fonts.ready;
                    
                    const fontFamily = config.customFontFamily || currentTheme.fontFamily;
                    console.log('2. ÂΩìÂâçÂ≠ó‰Ωì:', fontFamily);
                    
                    // È¢ÑÂä†ËΩΩÂ≠ó‰Ωì
                    const weights = ['normal', 'bold', '400', '500', '600', '700'];
                    for (const weight of weights) {
                        try {
                            await document.fonts.load(`${weight} 16px "${fontFamily}"`);
                        } catch (e) {
                            console.warn(`Â≠ó‰ΩìÂä†ËΩΩÂ§±Ë¥• ${weight}:`, e);
                        }
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 500));
                    console.log('3. Â≠ó‰ΩìÂä†ËΩΩÂÆåÊàê');
                    
                    const zip = new JSZip();
                    console.log('4. ÂàõÂª∫ZIP');
                    
                    for (let i = 0; i < pages.length; i++) {
                        console.log(`5. Â§ÑÁêÜÁ¨¨ ${i + 1} È°µ...`);
                        
                        const cardId = `card-${i}`;
                        const originalCard = document.getElementById(cardId);
                        
                        if (!originalCard) {
                            console.warn(`Âç°Áâá ${cardId} ‰∏çÂ≠òÂú®`);
                            continue;
                        }
                        
                        const currentWidth = originalCard.offsetWidth;
                        const currentHeight = originalCard.offsetHeight;
                        const targetWidth = config.exportWidth;
                        const targetHeight = config.exportHeight;
                        const pixelRatio = targetWidth / currentWidth;
                        
                        console.log(`  Â∞∫ÂØ∏: ${currentWidth}x${currentHeight} -> ${targetWidth}x${targetHeight}, ratio=${pixelRatio}`);
                        
                        try {
                            console.log(`  ÂºÄÂßãÊà™Âõæ...`);
                            
                            const dataUrl = await htmlToImage.toPng(originalCard, {
                                quality: 1.0,
                                pixelRatio: pixelRatio,
                                width: currentWidth,
                                height: currentHeight,
                                cacheBust: true,
                                style: {
                                    fontFamily: `"${fontFamily}", sans-serif`,
                                    boxShadow: 'none'
                                },
                                filter: (node) => {
                                    if (node.style) {
                                        node.style.fontFamily = `"${fontFamily}", sans-serif`;
                                    }
                                    return true;
                                }
                            });
                            
                            console.log(`  Êà™ÂõæÊàêÂäüÔºåÂ§ßÂ∞è: ${dataUrl.length} Â≠óËäÇ`);
                            
                            const base64Data = dataUrl.split(',')[1];
                            zip.file(`rednote-card-${i + 1}.png`, base64Data, {base64: true});
                            console.log(`  Ê∑ªÂä†Âà∞ZIPÊàêÂäü`);
                            
                        } catch (err) {
                            console.error(`  Á¨¨ ${i + 1} È°µÂØºÂá∫Â§±Ë¥•:`, err);
                            throw err; // ÈáçÊñ∞ÊäõÂá∫ÈîôËØØ‰ª•‰æøÂ§ñÂ±ÇÊçïËé∑
                        }
                        
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                    
                    console.log('6. ÁîüÊàêZIPÊñá‰ª∂...');
                    const content = await zip.generateAsync({ type: 'blob' });
                    
                    console.log('7. ‰∏ãËΩΩZIP...');
                    saveAs(content, 'rednote-cards.zip');
                    
                    console.log('=== ÂØºÂá∫ÂÆåÊàê ===');
                    
                } catch (error) {
                    console.error("‚ùå ÂØºÂá∫Â§±Ë¥•:", error);
                    console.error("ÈîôËØØÂ†ÜÊ†à:", error.stack);
                    alert(`ÂØºÂá∫Â§±Ë¥•: ${error.message}\nËØ∑Êü•ÁúãÊéßÂà∂Âè∞‰∫ÜËß£ËØ¶ÊÉÖ (ÊåâF12ÊâìÂºÄ)`);
                } finally {
                    setIsDownloading(false);
                }
            };

            return (
                <div className="flex h-screen w-full overflow-hidden bg-gray-100 font-sans">
                    <EditorSidebar
                        config={config} setConfig={setConfig}
                        content={content} setContent={setContent}
                        onDownload={handleDownload} isDownloading={isDownloading}
                        availableThemes={availableThemes} onThemeSelect={handleThemeSelect} onSaveTheme={handleSaveTheme}
                    />
                    <main className="flex-1 overflow-y-auto p-8 relative">
                        <div className="flex flex-wrap justify-center gap-8 pb-20">
                            {pages.map((pageContent, index) => (
                                <div key={index} className="flex flex-col gap-2">
                                    <span className="text-xs text-gray-400 font-mono text-center">{index === 0 ? "COVER" : `PAGE ${index}`}</span>
                                    <Card
                                        ref={el => cardsRef.current[index] = el}
                                        pageIndex={index}
                                        totalPages={pages.length - 1}
                                        config={config}
                                        content={content}
                                        theme={currentTheme}
                                        pageContent={pageContent || []}
                                    />
                                </div>
                            ))}
                        </div>
                        <div className="fixed bottom-6 right-8 pointer-events-none md:hidden">
                            <div className="bg-black/80 text-white px-4 py-2 rounded-full text-xs shadow-lg backdrop-blur">Scroll for more pages</div>
                        </div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>